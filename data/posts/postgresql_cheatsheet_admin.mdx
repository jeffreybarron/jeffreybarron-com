# Connections

## Configure to allow remote connections (Shell)

Change postgresql.conf

``$ sudo nano /etc/postgresql/14/main/postgresql.conf`
![[Pasted image 20220812100426.png]]

`/etc/postgresql/14/main/pg_hba.conf`
Replace
![[Pasted image 20220812100705.png]]
with
![[Pasted image 20220812100836.png]]

```shell
sudo service postgresql stop
sudo service postgresql start
```

## Login using postgres user

```bash
ssh -l postgres 192.168.16.152
or
ssh postgres@192.168.16.152
```

// Login as PostgreSQL superuser “postgres” on remote PostgreSQL server using ssh (Linux)

```bash
root@localhost:~# su - postgres
```

// Login as PostgreSQL superuser “postgres” (Linux)

---

## [Enter postgres terminal](https://postgrescheatsheet.com/#/connections?id=enter-postgres-terminal)

```bash
psql
```

// Enter PostgreSQL Command Line via “psql” client (psql)

---

## [Connect database](https://postgrescheatsheet.com/#/connections?id=connect-database)

```bash
\c test
You are now connected to database "test" as user "postgres".
```

// Connect to a PostgreSQL database “test” as “postgres” user (psql)

---

## [Check psql Client version](https://postgrescheatsheet.com/#/connections?id=check-psql-client-version)

```bash
$ psql -V
psql (PostgreSQL) 9.6.12
```

// Check psql client version (psql)

---

## [Check Postgres server version](https://postgrescheatsheet.com/#/connections?id=check-postgres-server-version)

```bash
select version();
                                                  version
-----------------------------------------------------------------------------------------------------------
 PostgreSQL 9.6.12 on x86_64-pc-linux-gnu, compiled by gcc (Debian 6.3.0-18+deb9u1) 6.3.0 20170516, 64-bit
(1 row)
```

// Check postgres server version (SQL)

# [Configuration](https://postgrescheatsheet.com/#/configuration?id=configuration)

## [Stop / Start postgresql service](https://postgrescheatsheet.com/#/configuration?id=stop-start-postgresql-service)

```bash
service postgresql stop
```

// Stops postgresql service through root user (Linux)

```bash
service postgresql start
```

// Starts postgresql service through root user (Linux)

```bash
service postgresql restart
```

// Restarts postgresql service through root user (Linux)

If running from non root user you must prefix your command with “sudo” and non-root user should already be there in sudoer’s list. Also be careful with running these commands because some distributors don’t provide them these days.

---

## [Display configuration parameters](https://postgrescheatsheet.com/#/configuration?id=display-configuration-parameters)

==show all==

// List all current runtime configuration parameter (psql)

---

## [Display configuration parameters using sql](https://postgrescheatsheet.com/#/configuration?id=display-configuration-parameters-using-sql)

```bash
select * from pg_settings;
```

// List all current runtime configuration parameter using sql with additional details including description (SQL)

---

## [Show current setting from “max_connections”](https://postgrescheatsheet.com/#/configuration?id=show-current-setting-from-max_connections)

```bash
SELECT current_setting('max_connections');
 current_setting
-----------------
 100
(1 row)
```

// Display current value set for “max_connections” parameter (SQL)

---

## [Show Postgres config file location](https://postgrescheatsheet.com/#/configuration?id=show-postgres-config-file-location)

```bash
show config_file;
               config_file
------------------------------------------
 /etc/postgresql/9.6/main/postgresql.conf
(1 row)
```

// Show PostgreSQL configuration file location (psql)

The PostgreSQL configuration files are stored in directory from above command output. The main configuration file is called “**postgresql.conf**“.

---

## [Display contents of postgres config file location](https://postgrescheatsheet.com/#/configuration?id=display-contents-of-postgres-config-file-location)

```bash
postgres@localhost:~$ less /etc/postgresql/9.6/main/postgresql.conf

. . . .
data_directory = '/var/lib/postgresql/9.6/main'         # use data in another directory
                                        # (change requires restart)
hba_file = '/etc/postgresql/9.6/main/pg_hba.conf'       # host-based authentication file
                                        # (change requires restart)
ident_file = '/etc/postgresql/9.6/main/pg_ident.conf'   # ident configuration file
                                        # (change requires restart)
listen_addresses = '*'                  # what IP address(es) to listen on;
                                        # comma-separated list of addresses;
                                        # defaults to 'localhost'; use '*' for all
                                        # (change requires restart)
port = 5432                             # (change requires restart)

. . . .
```

(Linux)

– `data_directory` directive tells where the database files are stored.  
– `hba_file` directive tells the host based authentication file.  
– `port` directive tells the TCP port number. The default is 5432.

# [Maintenance](https://postgrescheatsheet.com/#/maintenance?id=maintenance)

## [Garbage Collect (Reclaim Storage)](https://postgrescheatsheet.com/#/maintenance?id=garbage-collect-reclaim-storage)

```bash
VACUUM [__Table__]

vacuum(verbose, analyze) employee;
INFO:  vacuuming "public.employee"
INFO:  scanned index "employee_pkey" to remove 1 row versions
. . .
sample, 1 estimated total rows
VACUUM
```

// Use the vacuum command to reclaim storage from deleted rows in the employee table (SQL)

1.  Table rows that are deleted or obsoleted by an update are not physically removed from their table; they remain present until a VACUUM command is executed. Therefore it’s necessary to do VACUUM periodically, especially on frequently-updated tables.
2.  Verbose Prints a detailed vacuum activity report for each table.
3.  Analyze update statistics for table

---

## [Gather statistics](https://postgrescheatsheet.com/#/maintenance?id=gather-statistics)

```bash
ANALYZE [__table__]

analyze verbose employee;
INFO:  analyzing "public.employee"
INFO:  "employee": scanned 1 of 1 pages, containing 1 live rows and 0 dead rows; 1 rows in sample, 1 estimated total rows
ANALYZE
```

// Analyze a table and stores the results in the pg_statistic system catalog (SQL)

1.  ANALYZE gathers statistics for the query planner to create the most efficient query execution plans. Accurate statistics assist planner to choose the most appropriate query plan, and thereby improve the speed of query processing.
2.  Verbose Prints a detailed analyze activity report for each table.
3.  With no table name specified, ANALYZE examines every table in the current database

# [Backup](https://postgrescheatsheet.com/#/backup?id=backup)

## [Database Backup (With default options)](https://postgrescheatsheet.com/#/backup?id=database-backup-with-default-options)

```bash
$ pg_dump mydb > mydb.bak.sql
```

// Create a backup for a database “mydb” in plain-text SQL Script file (mydb.bak.sql) (pg_dump)

## [Database Backup (With Customised options)](https://postgrescheatsheet.com/#/backup?id=database-backup-with-customised-options)

```bash
$ pg_dump -c -C -F p -f mydb.bak.sql mydb
```

// Creates a backup for a database “mydb” in plain text format with drop & create database commands included in output file mydb.bak.sql (pg_dump)

Backup options:  
– `-c`: Output commands to clean(drop) database objects prior to writing commands to create them  
– `-C`: Begin output with “CREATE DATABASE” command itself and reconnect to created database – `-F`: Format of the output (value p means plain SQL output and value c means custom archive format suitable for pg_restore) – `-f`: Backup output file name

## [Remote Backup](https://postgrescheatsheet.com/#/backup?id=remote-backup)

```bash
$ pg_dump -h <remote_host> -p <port> -U <user> -f mydb.bak mydb
```

// Running pg_dump on client computer to back up data on a remote postgres server (pg_dump)

Use the -h flag to specify the IP address of your remote Host and -p to identify the port on which PostgreSQL is listening:

## [All databases backup](https://postgrescheatsheet.com/#/backup?id=all-databases-backup)

```bash
$ pg_dumpall > alldb.bak.sql
```

// Backup of all databases along with database roles and cluster wide information. (pg_dumpall)

# [Restore](https://postgrescheatsheet.com/#/restore?id=restore)

## [Restore from backup file (.sql)](https://postgrescheatsheet.com/#/restore?id=restore-from-backup-file-sql)

```bash
$ psql -U username -f filename.sql
```

// Restore database plain-text backup(.sql) generated by pg_dump or pg_dumpall with psql utility (psql)

## [Restore from custom archive backup file (.bak)](https://postgrescheatsheet.com/#/restore?id=restore-from-custom-archive-backup-file-bak)

```bash
$ pg_restore -d db_name /path/to/your/file/db_name.bak -c -U db_user
```

// Restore database custom archive backup(.bak) using pg_restore utility (pg_restore)

[  
](https://postgrescheatsheet.com/#/backup)

# [Monitoring](https://postgrescheatsheet.com/#/monitoring?id=monitoring)

## [Session Monitor](https://postgrescheatsheet.com/#/monitoring?id=session-monitor)

```bash
SELECT
    pid
    ,datname
    ,usename
    ,application_name
    ,client_hostname
    ,state
    ,client_port
    ,backend_start
    ,query_start
    ,query
FROM pg_stat_activity
```

// Monitors Postgres sessions (SQL)

Few important parameters to know

Pid - Backend Process ID

Datname - Database Name

Usename - User running the query

Application_name - Client Application Name

State - State of Session (e.g. Active, Waiting, Idle ..)

Query - Query executed

---

## [Cancel Running Query](https://postgrescheatsheet.com/#/monitoring?id=cancel-running-query)

```bash
SELECT pg_cancel_backend(pid);
```

// To cancel a running query with pid provided. This is useful in case of killing long running queries (SQL)

---

## [Biggest Postgres Table/Indexes by their sizes](https://postgrescheatsheet.com/#/monitoring?id=biggest-postgres-tableindexes-by-their-sizes)

```bash
SELECT
  nspname || '.' || relname AS "Object Name", relkind As "Object Type",
  pg_size_pretty(pg_relation_size(C.oid)) AS "size"
FROM pg_class C
LEFT JOIN pg_namespace N ON (N.oid = C.relnamespace)
WHERE nspname NOT IN ('pg_catalog', 'information_schema')
ORDER BY pg_relation_size(C.oid) DESC
LIMIT 20;
```

// Top 20 Big tables/Indexes (Excluding catalog tables) (SQL)

[  
](https://postgrescheatsheet.com/#/maintenance)

# [Indexes](https://postgrescheatsheet.com/#/indexes?id=indexes)

## [Create a new index on a table](https://postgrescheatsheet.com/#/indexes?id=create-a-new-index-on-a-table)

```bash
create index idx_employee_emp_name on employee using btree (emp_name asc);
```

// Create a new index on the emp_name column of employee table (SQL)

This index specifies “btree” as the index method and uses “asc” to store the index key column data in ascending order

---

## [View indexes of a table](https://postgrescheatsheet.com/#/indexes?id=view-indexes-of-a-table)

```bash
\d employee
postgres=# \d employee;
                                    Table "public.employee"
   Column   |         Type          |                         Modifiers
------------+-----------------------+-----------------------------------------------------------
 emp_id     | integer               | not null default nextval('employee_emp_id_seq'::regclass)
 emp_name   | character varying(50) | not null
 emp_salary | numeric(9,2)          | not null
Indexes:
    "employee_pkey" PRIMARY KEY, btree (emp_id)
    "idx_employee_emp_name" btree (emp_name)
```

// List indexes of a table along with table definition (psql)

---

## [List all indexes](https://postgrescheatsheet.com/#/indexes?id=list-all-indexes)

```bash
\di
                      List of relations
 Schema |         Name          | Type  |  Owner   |  Table
--------+-----------------------+-------+----------+----------
 public | employee_pkey         | index | postgres | employee
 public | idx_employee_emp_name | index | postgres | employee
(2 rows)
```

// List all indexes from all tables (psql)

---

## [Drop index from a table](https://postgrescheatsheet.com/#/indexes?id=drop-index-from-a-table)

```bash
drop index idx_employee_emp_name;
```

// Drop an existing index from a table (SQL)

[  
](https://postgrescheatsheet.com/#/users)
